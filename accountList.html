<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>帳號列表</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/toastr.min.css">


    <!-- DataTable Stylesheet -->
    <link rel="stylesheet" href="css/dataTables.bootstrap5.min.css">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">



</head>

<body>
    <div class="container-fluid position-relative bg-white d-flex p-0">
        <!-- Spinner Start -->
        <div id="spinner"
            class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <!-- Spinner End -->


        <!-- Sidebar Start -->
        <div class="sidebar pe-4 pb-3">
            <nav class="navbar bg-light navbar-light">
                <a href="index.html" class="navbar-brand mx-4 mb-3">
                    <h3 class="text-primary">進銷存後台</h3>
                </a>
                <div class="navbar-nav w-100" id="dynamicMenu">
                </div>
            </nav>
        </div>
        <!-- Sidebar End -->


        <!-- Content Start -->
        <div class="content">
            <!-- Navbar Start -->
            <nav class="navbar navbar-expand bg-light navbar-light sticky-top px-4 py-0">
                <a href="index.html" class="navbar-brand d-flex d-lg-none me-4">
                    <h2 class="text-primary mb-0"><i class="fa fa-hashtag"></i></h2>
                </a>
                <a href="#" class="sidebar-toggler flex-shrink-0">
                    <i class="fa fa-bars"></i>
                </a>

                <div class="navbar-nav align-items-center ms-auto">

                    <div class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="fa fa-bell me-lg-2"></i>
                        </a>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                            <img class="userImg rounded-circle me-lg-2" src="img/user.jpg" alt=""
                                style="width: 40px; height: 40px;">
                            <span class="d-none d-lg-inline-flex" id="userName">John Doe</span>
                        </a>
                        <div
                            class="dropdown-menu dropdown-menu-end bg-body-secondary border-0 rounded-0 rounded-bottom m-0">
                            <a href="#" class="dropdown-item">My Profile</a>
                            <a href="#" class="dropdown-item">Settings</a>
                            <a href="#" class="dropdown-item" id="logout">Log Out</a>
                        </div>
                    </div>
                </div>
            </nav>
            <!-- Navbar End -->


            <!-- Blank Start -->
            <div class="container-fluid pt-4 px-4">
                <div class="row bg-light rounded p-3 mx-0">
                    <div class="">
                        <h3>帳號列表</h3>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item active" aria-current="page">帳號管理 / 帳號列表</li>
                            </ol>
                        </nav>

                        <div class="py-1 my-5">
                            <button type="button" class="btn btn btn-primary me-2">
                                <a href="8-account-create.html" class="text-white text-decoration-none">新增</a>
                            </button>
                        </div>

                        <div class="row mb-3">
                            <span class="mb-3"> 可以依照選擇執行查詢項目、例如：選擇單一項目：所屬門市>搜尋</span>
                            <div class="col-sm-3">
                                <label for="A-shoplist" class="form-label">*所屬門市</label>
                                <select class="form-select" id="A-shoplist" required="">
                                </select>
                            </div>

                            <div class="col-sm-3">
                                <label for="A-auth" class="form-label">角色</label>
                                <select class="form-select" id="A-auth" required="">
                                </select>
                            </div>

                            <div class="col-sm-3">
                                <label for="A-status" class="form-label">*狀態</label>
                                <select class="form-select" id="A-status" name="status">
                                    <option value="1">正常</option>
                                    <option value="0">停業</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-5">
                            <button id="allBtn" type="button" class="btn btn btn-primary">全部</button>
                            <button id="searchBtn" type="button" class="btn btn btn-success">查詢</button>
                        </div>


                        <!-- 表格 -->
                        <div class="block-first">
                            <div class="tableList">
                                <div class="table-responsive">
                                    <table id="accountList" class="display  table table-striped">
                                        <thead>
                                            <tr>
                                                <th scope="col">項目操作</th>
                                                <th scope="col">帳號</th>
                                                <th scope="col">姓名</th>
                                                <th scope="col">所屬門市</th>
                                                <th scope="col">E-Mail</th>
                                                <th scope="col">手機</th>
                                                <th scope="col">角色</th>
                                                <th scope="col">帳號狀態</th>
                                                <th scope="col">創建時間</th>
                                            </tr>
                                        </thead>
                                        <tbody>

                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
            <!-- Blank End -->


            <!-- Footer Start -->
            <!-- Footer End -->
        </div>
        <!-- Content End -->


        <!-- Back to Top -->
        <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>
    </div>


    <!--  Boostrap JavaScript Libraries -->
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/Login/Authlogin.js"></script>
    <script src="js/crypto-js.js"></script>
    <script src="js/toastr.min.js"></script>
    <script src="js/Notifications/notifications.js"></script>
    <script src="js/Notifications/toastr-options.js"></script>


    <!-- Datatable Libraries -->
    <script src="js/jquery.dataTables.min.js"></script>
    <script src="js/dataTables.bootstrap5.js"></script>
    <script>
        $(document).ready(function () {
            new DataTable('#accountList');

        });
    </script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
    <script src="js/Public/munu.js"></script>

    TODO 三個列表各自帶給後端在取值
    <script>

        //取得商店資料、存取ID
        $(document).ready(function () {
            // 从localStorage中获取session_id和chsm
            // 解析JSON字符串为JavaScript对象
            const jsonStringFromLocalStorage = localStorage.getItem("userData");
            const gertuserData = JSON.parse(jsonStringFromLocalStorage);
            const user_session_id = gertuserData.sessionId;

            // chsm = session_id+action+'HBAdminStoreApi'
            // 組裝菜單所需資料
            var action = "getStoreList";
            var chsmtoGetManualList = user_session_id + action + "HBAdminStoreApi";
            var chsm = CryptoJS.MD5(chsmtoGetManualList).toString().toLowerCase();

            // 发送API请求以获取数据
            $.ajax({
                type: "POST",
                url: "https://88bakery.tw/HBAdmin/index.php?/api/store",
                data: { session_id: user_session_id, action: action, chsm: chsm },
                success: function (responseData) {

                    const storeList = document.getElementById("A-shoplist");

                    const defaultOption = document.createElement("option");
                    defaultOption.text = "請選擇門市";
                    defaultOption.value = ""
                    storeList.appendChild(defaultOption);

                    for (let i = 0; i < responseData.returnData.length; i++) {
                        const store = responseData.returnData[i];
                        const storeName = store.storeName;
                        const storeId = store.id
                        const option = document.createElement("option");
                        option.text = storeName;
                        option.value = storeId;

                        storeList.appendChild(option);
                    }
                },
                error: function (error) {
                    showErrorNotification();
                },
            });
        });

        // 取得權限資料、存取ID
        $(document).ready(function () {
            // 从localStorage中获取session_id和chsm
            // 解析JSON字符串为JavaScript对象
            const jsonStringFromLocalStorage = localStorage.getItem("userData");
            const gertuserData = JSON.parse(jsonStringFromLocalStorage);
            const user_session_id = gertuserData.sessionId;

            // chsm = session_id+action+'HBAdminAuthorizeApi'
            // 組裝菜單所需資料
            var action = "getAuthorizeList";
            var chsmtoGetManualList = user_session_id + action + 'HBAdminAuthorizeApi';
            var chsm = CryptoJS.MD5(chsmtoGetManualList).toString().toLowerCase();

            // 发送API请求以获取数据
            $.ajax({
                type: "POST",
                url: "https://88bakery.tw/HBAdmin/index.php?/api/authorize",
                data: { session_id: user_session_id, action: action, chsm: chsm },
                success: function (responseData) {
                    const rolleList = document.getElementById("A-auth");

                    const defaultOption = document.createElement("option");
                    defaultOption.text = "請選擇角色";
                    defaultOption.value = ""
                    rolleList.appendChild(defaultOption);

                    for (let i = 0; i < responseData.returnData.length; i++) {
                        const roll = responseData.returnData[i];
                        const rollName = roll.authorizeName;
                        const rollId = roll.id
                        const option = document.createElement("option");

                        option.text = rollName;
                        option.value = rollId;


                        rolleList.appendChild(option);
                    }
                },
                error: function (error) {
                    showErrorNotification();
                },
            });
        });

        // 監聽欄位變動
        $(document).ready(function () {
            var selectedShopId, selectedAuthId, selectedStatus;

            // 监听选择门市的变化
            $('#A-shoplist').on('change', function () {
                selectedShopId = $('#A-shoplist').val();
            });

            // 监听选择角色的变化
            $('#A-auth').on('change', function () {
                selectedAuthId = $('#A-auth').val();
            });

            // 监听选择状态的变化
            $('#A-status').on('change', function () {
                selectedStatus = $('#A-status').val();
            });



            // 点击搜索按钮时触发API请求
            $('#searchBtn').on('click', function () {
                // 创建筛选数据对象
                var filterData = {};

                if (selectedShopId) {
                    filterData.storeId = selectedShopId;
                }

                if (selectedAuthId) {
                    filterData.authorizeId = selectedAuthId;
                }

                if (selectedStatus) {
                    filterData.status = selectedStatus;
                }

                // 发送API请求以获取数据
                sendApiRequest(filterData);
            });

            // 创建一个函数，发送API请求以获取数据
            function sendApiRequest(filterData) {
                // 获取用户数据
                const jsonStringFromLocalStorage = localStorage.getItem("userData");
                const gertuserData = JSON.parse(jsonStringFromLocalStorage);
                const user_session_id = gertuserData.sessionId;

                // 设置API请求数据
                var action = "getAccountList";
                var chsmtoGetAccountList = user_session_id + action + 'HBAdminAccountApi';
                var chsm = CryptoJS.MD5(chsmtoGetAccountList).toString().toLowerCase();

                var filterDataJSON = JSON.stringify(filterData);
                var postData = filterDataJSON;
                $("#accountList").DataTable();
                // 发送API请求以获取数据
                $.ajax({
                    type: "POST",
                    url: "https://88bakery.tw/HBAdmin/index.php?/api/account",
                    data: { session_id: user_session_id, action: action, chsm: chsm, data: postData },
                    success: function (responseData) {
                        // 处理成功响应
                        console.log("成功响应：", responseData);
                        updatePageWithData(responseData);
                    },
                    error: function (error) {
                        showErrorNotification();
                    },
                });
            }
        });


        // //取帳號列表
        function fetchAccountList() {

            const jsonStringFromLocalStorage = localStorage.getItem("userData");
            const gertuserData = JSON.parse(jsonStringFromLocalStorage);
            const user_session_id = gertuserData.sessionId;

            // chsm = session_id+action+'HBAdminAccountApi'
            // 組裝菜單所需資料
            var action = "getAccountList";
            var chsmtoGetManualList = user_session_id + action + 'HBAdminAccountApi';
            var chsm = CryptoJS.MD5(chsmtoGetManualList).toString().toLowerCase();

            $("#accountList").DataTable();

            // 发送API请求以获取数据
            $.ajax({
                type: "POST",
                url: "https://88bakery.tw/HBAdmin/index.php?/api/account",
                data: { session_id: user_session_id, action: action, chsm: chsm },
                success: function (responseData) {
                    // 处理成功响应
                    console.log("成功响应：", responseData);
                    updatePageWithData(responseData);
                },
                error: function (error) {
                    showErrorNotification();
                },
            });
        }

        // 加载时调用在页面 fetchAccountList
        $(document).ready(function () {
            fetchAccountList();
        });

        // 或者在点击按钮时调用 fetchAccountList
        $('#allBtn').on('click', function () {
            fetchAccountList();
        });


        // 表格填充
        function updatePageWithData(responseData) {

            // 清空表格数据
            var dataTable = $("#accountList").DataTable();
            dataTable.clear().draw();

            // 填充API数据到表格，包括下载链接
            for (var i = 0; i < responseData.returnData.length; i++) {
                var data = responseData.returnData[i];

                var modifyButtonHtml = '<a href="8-account-update.html?id=' + data.id + '" class="btn btn-primary text-white">修改</a>';
                var statusText = data.status === '0' ? '停用' : '正常';

                dataTable.row
                    .add([
                        modifyButtonHtml,
                        data.account,
                        data.userName,
                        data.storeName,
                        data.email,
                        data.phoneNumber,
                        data.authorizeName,
                        statusText,
                        data.createTime,
                    ])
                    .draw(false);
            }
        }
    </script>
</body>

</html>